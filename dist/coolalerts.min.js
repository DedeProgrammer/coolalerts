// main.js
const bodyElement = document.body;

function createStyleElement() {
    const cssCode = `
    <style>
        /* variables.css */

        :root {
            --backgroundColor: light-dark(#f1f4f9, #0c1421);
            --borderColor: light-dark(rgba(206, 206, 206, 0.605), rgb(55, 55, 55));
            --mainColor: rgb(70, 85, 186);
            --mainFont: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --textColor: light-dark(#0c1421, #f1f4f9);
        
        }

        /* main.css */

        .coolalerts-default-font, .coolalerts-default-font * {
            font-family: var(--mainFont);
            font-weight: 600;
        }

        /* modal.css */

        #modal-integration {
            background-color: var(--backgroundColor);
            border: none;
            box-sizing: border-box;
            color-scheme: light dark;
            height: 100%; 
            max-height: none;
            max-width: none; 
            padding: 0rem 1rem;
            width: 100%; 
        }

        #modal-title {
            color: var(--textColor);
            font-size: 2rem;
            font-weight: 500;
            overflow: hidden;
            padding: 0.5rem 1rem 0 1rem;
            white-space: nowrap;    
            width: 72%;
            text-overflow: ellipsis;
        }
        
        #modal-content {
            position: absolute;
            top: 4.5rem;
            left: 2.5rem;
            right: 2.5em;
            bottom: 5rem;
            overflow: auto;
            white-space: wrap;
            color: var(--textColor);
            font-size: clamp(1.25rem, calc(2.5vw + 0.05rem), 1.35rem);
            font-weight: lighter;
            line-height: 1.7em;
        }
        
        #modal-btn {
            position: absolute;
            bottom: 1.3rem;
            right: 2.5rem;
            padding: 5px 10%;
            font-size: 1.1rem;
            font-weight: 400;
            background-color: var(--mainColor);
            border: 2px solid var(--borderColor);
            outline-offset: 2px;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.1s ease-in-out;
            overflow: hidden;
            white-space: nowrap;   
            width: 62%;
            text-overflow: ellipsis;
        }
        
        @media (min-width: 1070px) and (forced-colors: none) {
            #modal-integration {
                width: 75%;
                height: 70%;
                border-radius: 12px;
            }
        
            #modal-title {
                font-size: 1.8rem;
            }
        
            #modal-content {
                font-size: 1.2rem;
            }
        }
        </style>
    `;

    document.head.innerHTML = cssCode;
};

createStyleElement();

function setTheme(color) {
    bodyElement.style.setProperty('--mainColor', color);
}

function setFont(font) {
    bodyElement.style.setProperty('--mainFont', font)
}

// escape-input.js

function encodeEntities(text) {
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");    
}

function decodeEntities(text) {
    return text
        .replace(/&amp;/g, `&`)
        .replace(/&lt;/g, `<`)
        .replace(/&gt;/g, `>`)
        .replace(/&quot;/g, `"`)
        .replace(/&#039;/g, `'`);    
}

function escapeHtml(text) {
    return text
        .replace(/&/g, '')
        .replace(/</g, '')
        .replace(/>/g, '')
        .replace(/"/g, '')
        .replace(/'/g, '');
}

// modal.js

let modalSelectors;

let modalInitState = false;
let modalResolvePromise;

function initModal() {
    const modalHTML = `    
    <dialog id="modal-integration" class="coolalerts-default-font">
        <h2 id="modal-title"></h2>
        <pre><code id="modal-content"></code></pre>
        <button id="modal-btn"></button>
    </dialog>`;
    
    bodyElement.innerHTML = modalHTML;

    modalSelectors = {
        modal: document.getElementById('modal-integration'),
        modalTitle: document.getElementById('modal-title'),
        modalContent: document.getElementById('modal-content'),
        modalBtn: document.getElementById('modal-btn')
    }
};

const MODAL_ELEMENT_NAMES = [
    ['title', 'header'],
    ['content', 'text', 'main'],
    ['btn', 'button', 'footer']
];

function modalUpdate(title, content, btn) {
    modalSelectors.modalTitle.innerHTML = escapeHtml(title);
    modalSelectors.modalContent.innerHTML = encodeEntities(content);
    modalSelectors.modalBtn.innerHTML = escapeHtml(btn);
}

function modalCallback() {
    return new Promise((resolve) => {
        modalResolvePromise = resolve;
    });
}

function toggleModal(title, content, btn) {
    if (modalInitState === false) {
        initModal();
        modalInitState = true;
    }

    if(modalSelectors.modal.close) {
        modalSelectors.modal.showModal();
        modalUpdate(title, content, btn);
        
        modalSelectors.modalBtn.onclick = () => {
            modalSelectors.modal.close();
            modalResolvePromise('true');
            modalResolvePromise = null;
        }
    } else {
        modalSelectors.modal.close();
    }
}

function modalGet(type) {
    if (MODAL_ELEMENT_NAMES[0].includes(type)) {
        return modalSelectors.modalTitle.innerText;
    } 
    if (MODAL_ELEMENT_NAMES[1].includes(type)) {
        return decodeEntities(modalSelectors.modalContent.innerText);
    }
    if (MODAL_ELEMENT_NAMES[2].includes(type)) {
        return modalSelectors.modalBtn.innerText;
    }

    return undefined;
}

// index.js

window.coolalerts = {
    setTheme: setTheme,
    setFont: setFont,
    toggleModal: toggleModal,
    modalCallback: modalCallback,
    modalGet: modalGet,
};